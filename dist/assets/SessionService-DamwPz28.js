import{p as O,q as k,j as V,aD as L,t as y,v as d,y as I,z as E,J as $,w as S,x as W,ah as j,I as z,E as K}from"./index-CnhLTW6L.js";var x={},q=O;Object.defineProperty(x,"__esModule",{value:!0});var F=x.default=void 0,G=q(k()),N=V;F=x.default=(0,G.default)([(0,N.jsx)("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),(0,N.jsx)("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")],"WarningAmber");var B={},Y=O;Object.defineProperty(B,"__esModule",{value:!0});var H=B.default=void 0,U=Y(k()),J=V;H=B.default=(0,U.default)((0,J.jsx)("path",{d:"M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8M7.83 14c.37 0 .67.26.74.62.41 2.22 2.28 2.98 3.64 2.87.43-.02.79.32.79.75 0 .4-.32.73-.72.75-2.13.13-4.62-1.09-5.19-4.12-.08-.45.28-.87.74-.87"}),"WaterDrop");const Q="items",X="settings/vibeTags",A=["Glatt","Samtig","Kratzig","Kühl","Warm","Eng anliegend","Locker","Sicher","Verboten","Verführerisch","Diskret","Kraftvoll","Verspielt","Büro","Draußen","Sportlich"],nt=async e=>{try{const t=y(d,`users/${e}/${X}`),n=await S(t);if(n.exists()){const s=n.data();if(Array.isArray(s.list))return s.list}return await W(t,{list:A}),A}catch(t){return console.error("Fehler beim Laden der Vibe Tags:",t),A}},at=(e,t,n=24)=>{if(!e||e.mainCategory!=="Nylons")return null;let s=L(e.lastWorn);if(t&&Array.isArray(t)&&t.length>0){const i=t.find(w=>w.endTime);if(i){const w=L(i.endTime);w&&(!s||w>s)&&(s=w)}}if(!s)return null;const o=(new Date-s)/(1e3*60*60);return o<n?{isResting:!0,remainingHours:Math.ceil(n-o),progress:o/n*100}:null},Z=async(e,t,n)=>{if(!e||!t)return;const s=y(d,`users/${e}/${Q}`,t);await I(s,{wearCount:$(1),totalMinutes:$(n),lastWorn:E()})},tt={OVERDRAFT_PENALTY:1.5},P=async e=>{try{const t=y(d,`users/${e}/status/timeBank`),n=await S(t);if(n.exists())return n.data();{const s={nc:0,lc:0,updatedAt:E()};return await W(t,s),s}}catch(t){return console.error("Error loading TimeBank:",t),{nc:0,lc:0}}},it=async(e,t)=>{const n=await P(e),s=t==="nylon"?n.nc:n.lc,r=-2880;return{isBlocked:s<=r,currentDebt:Math.abs(s),remainingCredit:Math.max(0,s-r)}},rt=async(e,t,n)=>{if(t<=0)return!0;const s=n==="nylon"?"nc":"lc",r=y(d,`users/${e}/status/timeBank`),a=await S(r),o=a.exists()?a.data()[s]:0;let i=t;if((o<0||o-t<0)&&(i=Math.round(t*tt.OVERDRAFT_PENALTY),console.log(`TimeBank: Debt Penalty applied. Base: ${t}, Cost: ${i}`)),o-i<-2880)throw new Error("INSOLVENCY_LIMIT_REACHED");return await I(r,{[s]:$(-Math.abs(i)),lastTransaction:E()}),i},et=async(e,t,n)=>{const s=n==="nylon"?"nc":"lc",r=y(d,`users/${e}/status/timeBank`),a=await S(r);if(!a.exists())return;const o=a.data()[s];let i=0;if(o<0)i=t;else{if(t<3)return;i=Math.floor(t/3)}if(!(i<=0))return await I(r,{[s]:$(i),lastTransaction:E()}),console.log(`TimeBank: Added ${i} ${n.toUpperCase()} credits.`),i},ot=async(e,t)=>{const{items:n,itemId:s,type:r="voluntary",periodId:a,acceptedAt:o,note:i="",verifiedViaNfc:w=!1,instructionDurationMinutes:f=null}=t;if(!e)throw new Error("User ID fehlt.");let m=[];if(n&&Array.isArray(n)&&n.length>0?m=n:s&&(m=[{id:s}]),m.length===0)return;const C=m.map(u=>u.id),M=m[0],D=await P(e);let g=null,T=0;D.nc<0?(g="nylon",T=Math.abs(D.nc)):D.lc<0&&(g="lingerie",T=Math.abs(D.lc));let c=!1,l=0;if(g){const u=(M.subCategory||"").toLowerCase(),R=(M.mainCategory||"").toLowerCase(),_=u.includes("strumpfhose")||u.includes("tights")||u.includes("halterlose")||u.includes("stockings")||R.includes("nylons");if(g==="nylon"&&!_)throw new Error("BLOCKIERT: Nylon-Schulden müssen mit Nylons getilgt werden.");if(g==="lingerie"&&_)throw new Error("BLOCKIERT: Dessous-Schulden erfordern Lingerie.");c=!0,l=T,console.log(`DEBT PROTOCOL: Session enforced for ${T} mins (${g}).`)}let h=0;if(r==="instruction"&&o){const u=new Date(o);if(!isNaN(u.getTime())){const R=Date.now()-u.getTime();h=Math.max(0,Math.floor(R/6e4))}}const p={userId:e,itemId:C[0],itemIds:C,type:r,startTime:E(),endTime:null,isActive:!0,note:i,targetDurationMinutes:f?Number(f):null,complianceLagMinutes:h,isDebtSession:c,minDuration:l};r==="instruction"&&(p.periodId=a),w&&(p.verifiedViaNfc=!0);const b=await z(K(d,`users/${e}/sessions`),p),v=j(d);return C.forEach(u=>{v.update(y(d,`users/${e}/items`,u),{status:"wearing"})}),await v.commit(),{id:b.id,...p}},ct=async(e,t,n={})=>{var T;if(!e||!t)throw new Error("Parameter fehlen.");const s=y(d,`users/${e}/sessions`,t),r=await S(s);if(!r.exists()){console.error("Session nicht gefunden:",t);return}const a=r.data(),o=j(d),i=new Date,w=(T=a.startTime)!=null&&T.toDate?a.startTime.toDate():new Date,f=Math.round((i-w)/6e4);let m=null;const C=a.type==="instruction",M=a.periodId&&a.periodId.toLowerCase().includes("night");if(C&&!M){m=!1;const c=i.getTimezoneOffset()*6e4,l=new Date(i.getTime()-c).toISOString().split("T")[0];try{const h=y(d,`users/${e}/status/nightCompliance`),p=await S(h);if(p.exists()){const b=p.data();b.date===l&&(m=b.success)}}catch(h){console.error(h)}}const D={endTime:E(),isActive:!1,durationMinutes:f,feelings:n.feelings||[],finalNote:n.note||""};m!==null&&(D.nightSuccess=m),o.update(s,D);const g=a.itemIds||(a.itemId?[a.itemId]:[]);g.forEach(c=>{const l=y(d,`users/${e}/items`,c);o.update(l,{status:"active",lastWorn:E()})}),await o.commit();for(const c of g)await Z(e,c,f);if(a.type!=="punishment"&&!a.tzdExecuted){let c=0;if(a.isDebtSession)c=f;else if(a.type==="voluntary")c=f;else if(a.type==="instruction"){const l=Number(a.targetDurationMinutes)||0;l>0&&f>l&&(c=f-l,console.log(`Instruction Overtime: ${f} worn - ${l} target = ${c} eligible.`))}if(c>0){let l="lingerie";try{const h=g[0],p=await S(y(d,`users/${e}/items`,h));if(p.exists()){const b=p.data(),v=(b.subCategory||"").toLowerCase(),u=(b.mainCategory||"").toLowerCase();(v.includes("strumpfhose")||v.includes("tights")||v.includes("halterlose")||v.includes("stockings")||u.includes("nylons"))&&(l="nylon")}await et(e,c,l)}catch(h){console.error("Error calculating credits",h)}}}return{...a,endTime:i,durationMinutes:f}};export{F as a,ot as b,it as c,H as d,ct as e,at as f,P as g,nt as l,rt as s};
