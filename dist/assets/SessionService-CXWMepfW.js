import{p as W,q as j,j as k,$ as I,t as u,v as r,y as R,z as g,J as b,w,x as C,ai as L,I as V,E as z}from"./index-irBeTQ3W.js";var E={},O=W;Object.defineProperty(E,"__esModule",{value:!0});var q=E.default=void 0,P=O(j()),B=k;q=E.default=(0,P.default)([(0,B.jsx)("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),(0,B.jsx)("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")],"WarningAmber");var _={},K=W;Object.defineProperty(_,"__esModule",{value:!0});var G=_.default=void 0,U=K(j()),F=k;G=_.default=(0,U.default)((0,F.jsx)("path",{d:"M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8M7.83 14c.37 0 .67.26.74.62.41 2.22 2.28 2.98 3.64 2.87.43-.02.79.32.79.75 0 .4-.32.73-.72.75-2.13.13-4.62-1.09-5.19-4.12-.08-.45.28-.87.74-.87"}),"WaterDrop");const H="items",J="settings/vibeTags",A=["Glatt","Samtig","Kratzig","Kühl","Warm","Eng anliegend","Locker","Sicher","Verboten","Verführerisch","Diskret","Kraftvoll","Verspielt","Büro","Draußen","Sportlich"],Z=async e=>{try{const t=u(r,`users/${e}/${J}`),a=await w(t);if(a.exists()){const s=a.data();if(Array.isArray(s.list))return s.list}return await C(t,{list:A}),A}catch(t){return console.error("Fehler beim Laden der Vibe Tags:",t),A}},tt=(e,t,a=24)=>{if(!e||e.mainCategory!=="Nylons")return null;let s=I(e.lastWorn);if(t&&Array.isArray(t)&&t.length>0){const d=t.find(f=>f.endTime);if(d){const f=I(d.endTime);f&&(!s||f>s)&&(s=f)}}if(!s)return null;const l=(new Date-s)/(1e3*60*60);return l<a?{isResting:!0,remainingHours:Math.ceil(a-l),progress:l/a*100}:null},Q=async(e,t,a)=>{if(!e||!t)return;const s=u(r,`users/${e}/${H}`,t);await R(s,{wearCount:b(1),totalMinutes:b(a),lastWorn:g()})},et=async e=>{try{const t=u(r,`users/${e}/status/timeBank`),a=await w(t);if(a.exists())return a.data();{const s={nc:0,lc:0,updatedAt:g()};return await C(t,s),s}}catch(t){return console.error("Error loading TimeBank:",t),{nc:0,lc:0}}},st=async(e,t,a)=>{if(t<=0)return!0;const s=a==="nylon"?"nc":"lc",c=u(r,`users/${e}/status/timeBank`);await R(c,{[s]:b(-Math.abs(t)),lastTransaction:g()})},X=async(e,t,a)=>{if(t<3)return;const s=Math.floor(t/3);if(s<=0)return;const c=a==="nylon"?"nc":"lc",n=u(r,`users/${e}/status/timeBank`);return(await w(n)).exists()||await C(n,{nc:0,lc:0,updatedAt:g()}),await R(n,{[c]:b(s),lastTransaction:g()}),console.log(`TimeBank: Added ${s} ${a.toUpperCase()} credits for ${t} min work.`),s},at=async(e,t)=>{const{items:a,itemId:s,type:c="voluntary",periodId:n,acceptedAt:l,note:d="",verifiedViaNfc:f=!1,instructionDurationMinutes:p=null}=t;if(!e)throw new Error("User ID fehlt.");let m=[];if(a&&Array.isArray(a)&&a.length>0?m=a:s&&(m=[{id:s}]),m.length===0)return;const v=m.map(i=>i.id);let $=0;if(c==="instruction"&&l){const i=new Date(l);if(!isNaN(i.getTime())){const o=Date.now()-i.getTime();$=Math.max(0,Math.floor(o/6e4))}}const h={userId:e,itemId:v[0],itemIds:v,type:c,startTime:g(),endTime:null,isActive:!0,note:d,targetDurationMinutes:p||null,complianceLagMinutes:$};c==="instruction"&&(h.periodId=n),f&&(h.verifiedViaNfc=!0);const D=await V(z(r,`users/${e}/sessions`),h),T=L(r);return v.forEach(i=>{T.update(u(r,`users/${e}/items`,i),{status:"wearing"})}),await T.commit(),{id:D.id,...h}},nt=async(e,t,a={})=>{var T;if(!e||!t)throw new Error("Parameter fehlen.");const s=u(r,`users/${e}/sessions`,t),c=await w(s);if(!c.exists()){console.error("Session nicht gefunden:",t);return}const n=c.data(),l=L(r),d=new Date,f=(T=n.startTime)!=null&&T.toDate?n.startTime.toDate():new Date,p=Math.round((d-f)/6e4);let m=null;const v=n.type==="instruction",$=n.periodId&&n.periodId.toLowerCase().includes("night");if(v&&!$){m=!1;const i=d.getTimezoneOffset()*6e4,o=new Date(d.getTime()-i).toISOString().split("T")[0];try{const y=u(r,`users/${e}/status/nightCompliance`),S=await w(y);if(S.exists()){const M=S.data();M.date===o&&(m=M.success)}}catch(y){console.error(y)}}const h={endTime:g(),isActive:!1,durationMinutes:p,feelings:a.feelings||[],finalNote:a.note||""};m!==null&&(h.nightSuccess=m),l.update(s,h);const D=n.itemIds||(n.itemId?[n.itemId]:[]);D.forEach(i=>{const o=u(r,`users/${e}/items`,i);l.update(o,{status:"active",lastWorn:g()})}),await l.commit();for(const i of D)await Q(e,i,p);if(n.type!=="punishment"&&!n.tzdExecuted){let i=0;if(n.type==="voluntary")i=p;else if(n.type==="instruction"){const o=n.targetDurationMinutes||0;p>o&&o>0&&(i=p-o)}if(i>0){let o="lingerie";try{const y=D[0],S=await w(u(r,`users/${e}/items`,y));if(S.exists()){const M=S.data(),x=(M.subCategory||"").toLowerCase(),N=(M.mainCategory||"").toLowerCase();(x.includes("strumpfhose")||x.includes("tights")||x.includes("halterlose")||x.includes("stockings")||N.includes("nylons"))&&(o="nylon")}await X(e,i,o)}catch(y){console.error("Error calculating credits",y)}}}return{...n,endTime:d,durationMinutes:p}};export{q as a,at as b,nt as c,G as d,tt as e,et as g,Z as l,st as s};
