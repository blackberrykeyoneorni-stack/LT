import{m as pe,n as ve,j as Ie,u as ze,r as P,x as je,y as Ke,p as ye,z as We,A as Ae,E as Ge,o as Fe,q as Be}from"./index-DIK8iSn5.js";var Q={},Ue=pe;Object.defineProperty(Q,"__esModule",{value:!0});var Ye=Q.default=void 0,Je=Ue(ve()),Qe=Ie;Ye=Q.default=(0,Je.default)((0,Qe.jsx)("path",{d:"M9 1h6v2H9zm10.03 6.39 1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61M13 14h-2V8h2z"}),"Timer");const H=new Date("2025-12-15T00:00:00"),v=a=>typeof a=="number"?a.toFixed(1):"0.0",we=a=>typeof a=="number"?a.toFixed(2):"0.00",Ce=a=>{if(!a||a<=0)return"0m";const c=Math.floor(a/60),l=Math.round(a%60);return c>0?`${c}h ${l}m`:`${l}m`},q=a=>Ce(a*60),Xe=a=>{const c=new Date,l=new Date(c);l.setDate(c.getDate()-7);const r=a.filter(n=>{const t=n.startTime.toDate?n.startTime.toDate():new Date(n.startTime);return(n.endTime?n.endTime.toDate?n.endTime.toDate():new Date(n.endTime):new Date)>l&&t<c}).map(n=>{const t=n.startTime.toDate?n.startTime.toDate():new Date(n.startTime),u=n.endTime?n.endTime.toDate?n.endTime.toDate():new Date(n.endTime):new Date;return{start:Math.max(t.getTime(),l.getTime()),end:Math.min(u.getTime(),c.getTime())}}).filter(n=>n.end>n.start);if(r.length===0)return 0;r.sort((n,t)=>n.start-t.start);const g=[];let o=r[0];for(let n=1;n<r.length;n++)r[n].start<o.end?o.end=Math.max(o.end,r[n].end):(g.push(o),o=r[n]);g.push(o);const D=g.reduce((n,t)=>n+(t.end-t.start),0),m=7*24*60*60*1e3;return Math.min(100,D/m*100)},Ze=(a,c,l)=>c.some(s=>{const r=s.startTime.toDate?s.startTime.toDate():new Date(s.startTime),g=s.endTime?s.endTime.toDate?s.endTime.toDate():new Date(s.endTime):new Date;return a>=r&&a<=g?(s.itemIds||(s.itemId?[s.itemId]:[])).some(D=>{const m=l.find(t=>t.id===D);return m?(m.subCategory||"").toLowerCase().includes("strumpfhose"):!1}):!1}),et=(a,c,l)=>{const s=new Date(a);s.setHours(0,0,0,0);const r=new Date(a);r.setHours(23,59,59,999);const o=c.filter(t=>{const u=t.startTime.toDate?t.startTime.toDate():new Date(t.startTime),d=t.endTime?t.endTime.toDate?t.endTime.toDate():new Date(t.endTime):new Date;return u>r||d<s?!1:(t.itemIds||(t.itemId?[t.itemId]:[])).some(O=>{const M=l.find($=>$.id===O);if(!M)return!1;const C=(M.mainCategory||"").toLowerCase(),S=(M.subCategory||"").toLowerCase();return C.includes("nylon")||S.includes("strumpfhose")||S.includes("stockings")})}).map(t=>{const u=t.startTime.toDate?t.startTime.toDate():new Date(t.startTime),d=t.endTime?t.endTime.toDate?t.endTime.toDate():new Date(t.endTime):new Date;return{start:Math.max(u.getTime(),s.getTime()),end:Math.min(d.getTime(),r.getTime())}}).filter(t=>t.end>t.start);if(o.length===0)return 0;o.sort((t,u)=>t.start-u.start);const D=[];let m=o[0];for(let t=1;t<o.length;t++)o[t].start<m.end?m.end=Math.max(m.end,o[t].end):(D.push(m),m=o[t]);D.push(m);const n=D.reduce((t,u)=>t+(u.end-u.start),0);return Math.floor(n/6e4)};function it(a=[],c,l){const{currentUser:s}=ze(),[r,g]=P.useState(0),[o,D]=P.useState(!0),[m,n]=P.useState({health:{orphanCount:0},financials:{avgCPW:"0.00"},usage:{nylonIndex:"0.0"},spermaScore:{rate:"0.0",total:0,count:0},coreMetrics:{nylonEnclosure:"0.0",nocturnal:"0.0",nylonGap:"0m",cpnh:"0.00",complianceLag:"0m",coverage:"0.0",resistance:"0.0",voluntarism:"0.0%",endurance:"0m",enduranceNylon:"0m",enduranceDessous:"0m",submission:"85.0",denial:"12.0",chastity:"0.0"},femIndex:{score:0,trend:"neutral",subScores:{physis:0,psyche:0,infiltration:0}},basics:{activeItems:0,washing:0,wornToday:0,archived:0}});return P.useEffect(()=>{if(!s)return;(async()=>{D(!0);try{let d=[];if(l)d=[...l,...c||[]];else{const e=je(Ke(ye,`users/${s.uid}/sessions`),We("startTime",">=",H),Ae("startTime","desc"));d=(await Ge(e)).docs.map(h=>({id:h.id,...h.data()}))}let I={totalReleases:0,cleanReleases:0,keptOn:0};const O=Fe(ye,`users/${s.uid}/stats/releaseStats`),M=await Be(O);if(M.exists()){const e=M.data();I={totalReleases:Number(e.totalReleases)||0,cleanReleases:Number(e.cleanReleases)||0,keptOn:Number(e.keptOn)||0}}const C=d.filter(e=>(e.startTime.toDate?e.startTime.toDate():new Date(e.startTime))>=H),S=a.filter(e=>e.status==="active"),$=a.filter(e=>e.status==="washing"),Me=a.filter(e=>e.status==="archived"),be=a.filter(e=>e.status==="active"&&(!e.wearCount||e.wearCount===0)).length;let Z=0,k=0;a.forEach(e=>{Z+=parseFloat(e.cost)||0,k+=parseInt(e.wearCount)||0});const Se=k>0?Z/k:0,ee=a.filter(e=>e.status!=="archived"&&(e.mainCategory&&e.mainCategory==="Nylons"||e.subCategory&&e.subCategory&&e.subCategory.toLowerCase().includes("strumpfhose"))),x=new Date,E=new Date;E.setDate(x.getDate()-30);const xe=d.filter(e=>(e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date)>=E);let te=0;const z=new Set;xe.forEach(e=>{const i=e.itemIds||(e.itemId?[e.itemId]:[]);let h=!1;if(i.forEach(f=>{const b=a.find(N=>N.id===f);if(!b)return;const y=b.mainCategory||"",w=(b.subCategory||"").toLowerCase();(y==="Nylons"||w.includes("strumpfhose")||w.includes("stockings"))&&(h=!0,z.add(f))}),h){const f=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),b=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,y=f<E?E:f,w=b;w>y&&(te+=(w-y)/6e4)}});const Ee=z.size>0?te/z.size/60:0,Re=ee.reduce((e,i)=>e+(Number(i.totalMinutes)||0),0),Le=ee.reduce((e,i)=>e+(Number(i.cost)||0),0),ne=Re/60,Ve=ne>0?Le/ne:0,ae=Xe(d);let j=0,se=0;const R=new Date(H);for(;R<=x;){j++;const e=new Date(R);e.setHours(2,0,0,0),e<=x&&Ze(e,d,a)&&se++,R.setDate(R.getDate()+1)}const oe=j>0?se/j*100:0;let re=0,K=0;const L=new Date(H);for(;L<=x;){K++;const e=et(L,d,a);re+=(1440-e)/60,L.setDate(L.getDate()+1)}const Ne=K>0?re/K:24;let W=0,ie=0,ce=0,A=0;C.forEach(e=>{const i=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),h=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,f=Math.max(0,h.getTime()-i.getTime());W+=f,e.type==="voluntary"&&(ie+=f),typeof e.complianceLagMinutes=="number"&&(ce+=e.complianceLagMinutes,A++)});const le=W>0?ie/W*100:0,ue=C.length>0?C.filter(e=>e.type==="punishment").length/C.length*100:0,de=A>0?ce/A:0,_e=C.filter(e=>e.startTime);let V=0,G=0,F=0,B=0,me=0,U=0;_e.forEach(e=>{const i=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),h=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,f=Math.max(0,(h-i)/36e5),y=(e.itemIds||(e.itemId?[e.itemId]:[])).map(T=>a.find(p=>p.id===T)).filter(T=>T);if(y.length===0)return;const w=y.some(T=>{const p=(T.subCategory||"").toLowerCase();return(T.mainCategory||"").toLowerCase().includes("nylon")||p.includes("strumpfhose")||p.includes("stockings")}),N=y.some(T=>{const p=(T.subCategory||"").toLowerCase(),_=(T.mainCategory||"").toLowerCase();return _.includes("dessous")||_.includes("wÃ¤sche")||p.includes("body")||p.includes("slip")||p.includes("bh")||_.includes("corsage")});(w||N)&&(V+=f,G++),w&&(F+=f,B++),N&&(me+=f,U++)});const fe=G>0?V/G:0,Pe=B>0?F/B:0,He=U>0?me/U:0,Y=V>0?F/V*100:0,qe=I.totalReleases>0?I.cleanReleases/I.totalReleases*100:0,De=Math.min(100,fe/12*100)*.4+Y*.6,Oe=Math.max(0,100-de*1.6),he=Math.max(0,le*.6+Oe*.4-ue*2),Te=oe*.5+ae*.5,$e=Math.round(De*.3+he*.3+Te*.4),ge=new Date;ge.setHours(0,0,0,0);const ke=d.filter(e=>e.startTime?(e.startTime.toDate?e.startTime.toDate():new Date(e.startTime))>=ge:!1),J=new Set;ke.forEach(e=>{e.itemId&&J.add(e.itemId),e.itemIds&&e.itemIds.forEach(i=>J.add(i))}),n({health:{orphanCount:be},financials:{avgCPW:we(Se)},usage:{nylonIndex:v(Ee)},spermaScore:{rate:v(qe),total:I.totalReleases,count:I.cleanReleases},coreMetrics:{nylonEnclosure:v(Y),nocturnal:v(oe),nylonGap:q(Ne),cpnh:we(Ve),complianceLag:Ce(de),coverage:v(ae),resistance:v(ue),voluntarism:v(le)+"%",endurance:q(fe),enduranceNylon:q(Pe),enduranceDessous:q(He),submission:"85.0",denial:"12.0",chastity:v(Y)},femIndex:{score:Math.min(100,$e),trend:"stable",subScores:{physis:Math.round(De),psyche:Math.round(he),infiltration:Math.round(Te)}},basics:{activeItems:S.length,washing:$.length,wornToday:J.size,archived:Me.length}})}catch(d){console.error("Error fetching KPIs:",d)}finally{D(!1)}})()},[a,c,l,s,r]),{...m,loading:o,refreshKPIs:()=>g(u=>u+1)}}var X={},tt=pe;Object.defineProperty(X,"__esModule",{value:!0});var nt=X.default=void 0,at=tt(ve()),st=Ie;nt=X.default=(0,at.default)((0,st.jsx)("path",{d:"M12 1 3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11z"}),"Security");export{Ye as a,nt as d,it as u};
