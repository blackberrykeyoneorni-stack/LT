import{m as ve,n as Ie,j as Ce,u as Oe,r as P,x as $e,y as ze,p as we,z as je,A as Ke,E as We,o as Ae,q as Ge}from"./index-DbclkV5a.js";var Q={},Fe=ve;Object.defineProperty(Q,"__esModule",{value:!0});var Be=Q.default=void 0,Ue=Fe(Ie()),Ye=Ce;Be=Q.default=(0,Ue.default)((0,Ye.jsx)("path",{d:"M9 1h6v2H9zm10.03 6.39 1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61M13 14h-2V8h2z"}),"Timer");const H=new Date("2025-12-15T00:00:00"),I=n=>typeof n=="number"&&!isNaN(n)?n.toFixed(1):"0.0",pe=n=>typeof n=="number"&&!isNaN(n)?n.toFixed(2):"0.00",Me=n=>{if(typeof n!="number"||isNaN(n)||n<=0)return"0m";const c=Math.floor(n/60),l=Math.round(n%60);return c>0?`${c}h ${l}m`:`${l}m`},k=n=>Me(n*60),Je=n=>{const c=new Date,l=new Date(c);l.setDate(c.getDate()-7);const i=n.filter(a=>{const t=a.startTime.toDate?a.startTime.toDate():new Date(a.startTime);return(a.endTime?a.endTime.toDate?a.endTime.toDate():new Date(a.endTime):new Date)>l&&t<c}).map(a=>{const t=a.startTime.toDate?a.startTime.toDate():new Date(a.startTime),u=a.endTime?a.endTime.toDate?a.endTime.toDate():new Date(a.endTime):new Date;return{start:Math.max(t.getTime(),l.getTime()),end:Math.min(u.getTime(),c.getTime())}}).filter(a=>a.end>a.start);if(i.length===0)return 0;i.sort((a,t)=>a.start-t.start);const y=[];let r=i[0];for(let a=1;a<i.length;a++)i[a].start<r.end?r.end=Math.max(r.end,i[a].end):(y.push(r),r=i[a]);y.push(r);const T=y.reduce((a,t)=>a+(t.end-t.start),0),m=7*24*60*60*1e3;return Math.min(100,T/m*100)},Qe=(n,c,l)=>c.some(s=>{const i=s.startTime.toDate?s.startTime.toDate():new Date(s.startTime),y=s.endTime?s.endTime.toDate?s.endTime.toDate():new Date(s.endTime):new Date;return n>=i&&n<=y?(s.itemIds||(s.itemId?[s.itemId]:[])).some(T=>{const m=l.find(t=>t.id===T);return m?(m.subCategory||"").toLowerCase().includes("strumpfhose"):!1}):!1}),Xe=(n,c,l)=>{const s=new Date(n);s.setHours(0,0,0,0);const i=new Date(n);i.setHours(23,59,59,999);const r=c.filter(t=>{const u=t.startTime.toDate?t.startTime.toDate():new Date(t.startTime),d=t.endTime?t.endTime.toDate?t.endTime.toDate():new Date(t.endTime):new Date;return u>i||d<s?!1:(t.itemIds||(t.itemId?[t.itemId]:[])).some(M=>{const b=l.find(O=>O.id===M);if(!b)return!1;const q=(b.mainCategory||"").toLowerCase(),N=(b.subCategory||"").toLowerCase();return q.includes("nylon")||N.includes("strumpfhose")||N.includes("stockings")})}).map(t=>{const u=t.startTime.toDate?t.startTime.toDate():new Date(t.startTime),d=t.endTime?t.endTime.toDate?t.endTime.toDate():new Date(t.endTime):new Date;return{start:Math.max(u.getTime(),s.getTime()),end:Math.min(d.getTime(),i.getTime())}}).filter(t=>t.end>t.start);if(r.length===0)return 0;r.sort((t,u)=>t.start-u.start);const T=[];let m=r[0];for(let t=1;t<r.length;t++)r[t].start<m.end?m.end=Math.max(m.end,r[t].end):(T.push(m),m=r[t]);T.push(m);const a=T.reduce((t,u)=>t+(u.end-u.start),0);return Math.floor(a/6e4)};function ot(n=[],c,l){const{currentUser:s}=Oe(),[i,y]=P.useState(0),[r,T]=P.useState(!0),[m,a]=P.useState({health:{orphanCount:0},financials:{avgCPW:"0.00"},usage:{nylonIndex:"0.0"},spermaScore:{rate:"0.0",total:0,count:0},coreMetrics:{nylonEnclosure:"0.0",nocturnal:"0.0",nylonGap:"0m",cpnh:"0.00",complianceLag:"0m",coverage:"0.0",resistance:"0.0",voluntarism:"0.0%",endurance:"0m",enduranceNylon:"0m",enduranceDessous:"0m",submission:"85.0",denial:"12.0",chastity:"0.0"},femIndex:{score:0,trend:"neutral",subScores:{physis:0,psyche:0,infiltration:0}},basics:{activeItems:0,washing:0,wornToday:0,archived:0}});return P.useEffect(()=>{if(!s)return;(async()=>{T(!0);try{let d=[];if(l)d=[...l,...c||[]];else{const e=$e(ze(we,`users/${s.uid}/sessions`),je("startTime",">=",H),Ke("startTime","desc"));d=(await We(e)).docs.map(f=>({id:f.id,...f.data()}))}let C={totalReleases:0,cleanReleases:0,keptOn:0};try{const e=Ae(we,`users/${s.uid}/stats/releaseStats`),o=await Ge(e);if(o.exists()){const f=o.data();C={totalReleases:Number(f.totalReleases)||0,cleanReleases:Number(f.cleanReleases)||0,keptOn:Number(f.keptOn)||0}}}catch(e){console.warn("Release stats konnten nicht geladen werden",e)}const M=d.filter(e=>(e.startTime.toDate?e.startTime.toDate():new Date(e.startTime))>=H),b=n.filter(e=>e.status==="active"),q=n.filter(e=>e.status==="washing"),N=n.filter(e=>e.status==="archived"),O=n.filter(e=>e.status==="active"&&(!e.wearCount||e.wearCount===0)).length;let Z=0,$=0;n.forEach(e=>{Z+=parseFloat(e.cost)||0,$+=parseInt(e.wearCount)||0});const be=$>0?Z/$:0,ee=n.filter(e=>e.status!=="archived"&&(e.mainCategory&&e.mainCategory==="Nylons"||e.subCategory&&e.subCategory&&e.subCategory.toLowerCase().includes("strumpfhose"))),S=new Date,x=new Date;x.setDate(S.getDate()-30);const Ne=d.filter(e=>(e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date)>=x);let te=0;const z=new Set;Ne.forEach(e=>{const o=e.itemIds||(e.itemId?[e.itemId]:[]);let f=!1;if(o.forEach(D=>{const w=n.find(V=>V.id===D);if(!w)return;const h=w.mainCategory||"",p=(w.subCategory||"").toLowerCase();(h==="Nylons"||p.includes("strumpfhose")||p.includes("stockings"))&&(f=!0,z.add(D))}),f){const D=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),w=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,h=D<x?x:D,p=w;p>h&&(te+=(p-h)/6e4)}});const Se=z.size>0?te/z.size/60:0,xe=ee.reduce((e,o)=>e+(Number(o.totalMinutes)||0),0),Re=ee.reduce((e,o)=>e+(Number(o.cost)||0),0),ne=xe/60,Ee=ne>0?Re/ne:0,ae=Je(d);let j=0,se=0;const R=new Date(H);for(;R<=S;){j++;const e=new Date(R);e.setHours(2,0,0,0),e<=S&&Qe(e,d,n)&&se++,R.setDate(R.getDate()+1)}const oe=j>0?se/j*100:0;let re=0,K=0;const E=new Date(H);for(;E<=S;){K++;const e=Xe(E,d,n);re+=(1440-e)/60,E.setDate(E.getDate()+1)}const Le=K>0?re/K:24;let W=0,ie=0,ce=0,A=0;M.forEach(e=>{const o=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),f=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,D=Math.max(0,f.getTime()-o.getTime());W+=D,e.type==="voluntary"&&(ie+=D);const w=e.complianceLagMinutes,h=Number(w);!isNaN(h)&&h>=0&&(ce+=h,A++)});const le=W>0?ie/W*100:0,ue=M.length>0?M.filter(e=>e.type==="punishment").length/M.length*100:0,de=A>0?ce/A:0,Ve=M.filter(e=>e.startTime);let L=0,G=0,F=0,B=0,me=0,U=0;Ve.forEach(e=>{const o=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),f=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,D=Math.max(0,(f-o)/36e5),h=(e.itemIds||(e.itemId?[e.itemId]:[])).map(g=>n.find(v=>v.id===g)).filter(g=>g);if(h.length===0)return;const p=h.some(g=>{const v=(g.subCategory||"").toLowerCase();return(g.mainCategory||"").toLowerCase().includes("nylon")||v.includes("strumpfhose")||v.includes("stockings")}),V=h.some(g=>{const v=(g.subCategory||"").toLowerCase(),_=(g.mainCategory||"").toLowerCase();return _.includes("dessous")||_.includes("wÃ¤sche")||v.includes("body")||v.includes("slip")||v.includes("bh")||_.includes("corsage")});(p||V)&&(L+=D,G++),p&&(F+=D,B++),V&&(me+=D,U++)});const fe=G>0?L/G:0,_e=B>0?F/B:0,Pe=U>0?me/U:0,Y=L>0?F/L*100:0,He=C.totalReleases>0?C.cleanReleases/C.totalReleases*100:0,De=Math.min(100,fe/12*100)*.4+Y*.6,ke=Math.max(0,100-de*1.6),he=Math.max(0,le*.6+ke*.4-ue*2),Te=oe*.5+ae*.5,ge=Math.round(De*.3+he*.3+Te*.4),ye=new Date;ye.setHours(0,0,0,0);const qe=d.filter(e=>e.startTime?(e.startTime.toDate?e.startTime.toDate():new Date(e.startTime))>=ye:!1),J=new Set;qe.forEach(e=>{e.itemId&&J.add(e.itemId),e.itemIds&&e.itemIds.forEach(o=>J.add(o))}),a({health:{orphanCount:O},financials:{avgCPW:pe(be)},usage:{nylonIndex:I(Se)},spermaScore:{rate:I(He),total:C.totalReleases,count:C.cleanReleases},coreMetrics:{nylonEnclosure:I(Y),nocturnal:I(oe),nylonGap:k(Le),cpnh:pe(Ee),complianceLag:Me(de),coverage:I(ae),resistance:I(ue),voluntarism:I(le)+"%",endurance:k(fe),enduranceNylon:k(_e),enduranceDessous:k(Pe),submission:"85.0",denial:"12.0",chastity:I(Y)},femIndex:{score:isNaN(ge)?0:Math.min(100,ge),trend:"stable",subScores:{physis:Math.round(De),psyche:Math.round(he),infiltration:Math.round(Te)}},basics:{activeItems:b.length,washing:q.length,wornToday:J.size,archived:N.length}})}catch(d){console.error("Error fetching KPIs:",d)}finally{T(!1)}})()},[n,c,l,s,i]),{...m,loading:r,refreshKPIs:()=>y(u=>u+1)}}var X={},Ze=ve;Object.defineProperty(X,"__esModule",{value:!0});var et=X.default=void 0,tt=Ze(Ie()),nt=Ce;et=X.default=(0,tt.default)((0,nt.jsx)("path",{d:"M12 1 3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11z"}),"Security");export{Be as a,et as d,ot as u};
