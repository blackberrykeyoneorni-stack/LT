import{m as Q,n as X,j as Z,u as Oe,r as P,x as ke,y as ze,p as Ce,z as Ke,E as We,A as Ae,o as Ge,q as Fe}from"./index-D8WB5g1X.js";var ee={},Ue=Q;Object.defineProperty(ee,"__esModule",{value:!0});var Be=ee.default=void 0,Ye=Ue(X()),Je=Z;Be=ee.default=(0,Ye.default)((0,Je.jsx)("path",{d:"M9 1h6v2H9zm10.03 6.39 1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61M13 14h-2V8h2z"}),"Timer");const $=new Date("2025-12-15T00:00:00"),I=n=>typeof n=="number"&&!isNaN(n)?n.toFixed(1):"0.0",Me=n=>typeof n=="number"&&!isNaN(n)?n.toFixed(2):"0.00",be=n=>{if(typeof n!="number"||isNaN(n)||n<=0)return"0m";const c=Math.floor(n/60),l=Math.round(n%60);return c>0?`${c}h ${l}m`:`${l}m`},H=n=>be(n*60),Qe=n=>{const c=new Date,l=new Date(c);l.setDate(c.getDate()-7);const i=n.filter(a=>{const t=a.startTime.toDate?a.startTime.toDate():new Date(a.startTime);return(a.endTime?a.endTime.toDate?a.endTime.toDate():new Date(a.endTime):new Date)>l&&t<c}).map(a=>{const t=a.startTime.toDate?a.startTime.toDate():new Date(a.startTime),u=a.endTime?a.endTime.toDate?a.endTime.toDate():new Date(a.endTime):new Date;return{start:Math.max(t.getTime(),l.getTime()),end:Math.min(u.getTime(),c.getTime())}}).filter(a=>a.end>a.start);if(i.length===0)return 0;i.sort((a,t)=>a.start-t.start);const y=[];let r=i[0];for(let a=1;a<i.length;a++)i[a].start<r.end?r.end=Math.max(r.end,i[a].end):(y.push(r),r=i[a]);y.push(r);const T=y.reduce((a,t)=>a+(t.end-t.start),0),m=7*24*60*60*1e3;return Math.min(100,T/m*100)},Xe=(n,c,l)=>c.some(s=>{const i=s.startTime.toDate?s.startTime.toDate():new Date(s.startTime),y=s.endTime?s.endTime.toDate?s.endTime.toDate():new Date(s.endTime):new Date;return n>=i&&n<=y?(s.itemIds||(s.itemId?[s.itemId]:[])).some(T=>{const m=l.find(t=>t.id===T);return m?(m.subCategory||"").toLowerCase().includes("strumpfhose"):!1}):!1}),Ze=(n,c,l)=>{const s=new Date(n);s.setHours(0,0,0,0);const i=new Date(n);i.setHours(23,59,59,999);const r=c.filter(t=>{const u=t.startTime.toDate?t.startTime.toDate():new Date(t.startTime),d=t.endTime?t.endTime.toDate?t.endTime.toDate():new Date(t.endTime):new Date;return u>i||d<s?!1:(t.itemIds||(t.itemId?[t.itemId]:[])).some(M=>{const b=l.find(q=>q.id===M);if(!b)return!1;const j=(b.mainCategory||"").toLowerCase(),S=(b.subCategory||"").toLowerCase();return j.includes("nylon")||S.includes("strumpfhose")||S.includes("stockings")})}).map(t=>{const u=t.startTime.toDate?t.startTime.toDate():new Date(t.startTime),d=t.endTime?t.endTime.toDate?t.endTime.toDate():new Date(t.endTime):new Date;return{start:Math.max(u.getTime(),s.getTime()),end:Math.min(d.getTime(),i.getTime())}}).filter(t=>t.end>t.start);if(r.length===0)return 0;r.sort((t,u)=>t.start-u.start);const T=[];let m=r[0];for(let t=1;t<r.length;t++)r[t].start<m.end?m.end=Math.max(m.end,r[t].end):(T.push(m),m=r[t]);T.push(m);const a=T.reduce((t,u)=>t+(u.end-u.start),0);return Math.floor(a/6e4)};function ut(n=[],c,l){const{currentUser:s}=Oe(),[i,y]=P.useState(0),[r,T]=P.useState(!0),[m,a]=P.useState({health:{orphanCount:0},financials:{avgCPW:"0.00"},usage:{nylonIndex:"0.0"},spermaScore:{rate:"0.0",total:0,count:0},coreMetrics:{nylonEnclosure:"0.0",nocturnal:"0.0",nylonGap:"0m",cpnh:"0.00",complianceLag:"0m",coverage:"0.0",resistance:"0.0",voluntarism:"0.0%",endurance:"0m",enduranceNylon:"0m",enduranceDessous:"0m",submission:"85.0",denial:"12.0",chastity:"0.0"},femIndex:{score:0,trend:"neutral",subScores:{physis:0,psyche:0,infiltration:0}},basics:{activeItems:0,washing:0,wornToday:0,archived:0}});return P.useEffect(()=>{if(!s)return;(async()=>{T(!0);try{let d=[];if(l)d=[...l,...c||[]];else{const e=ke(ze(Ce,`users/${s.uid}/sessions`),Ke("startTime",">=",$),We("startTime","desc"));d=(await Ae(e)).docs.map(f=>({id:f.id,...f.data()}))}let C={totalReleases:0,cleanReleases:0,keptOn:0};try{const e=Ge(Ce,`users/${s.uid}/stats/releaseStats`),o=await Fe(e);if(o.exists()){const f=o.data();C={totalReleases:Number(f.totalReleases)||0,cleanReleases:Number(f.cleanReleases)||0,keptOn:Number(f.keptOn)||0}}}catch(e){console.warn("Release stats konnten nicht geladen werden",e)}const M=d.filter(e=>(e.startTime.toDate?e.startTime.toDate():new Date(e.startTime))>=$),b=n.filter(e=>e.status==="active"),j=n.filter(e=>e.status==="washing"),S=n.filter(e=>e.status==="archived"),q=n.filter(e=>e.status==="active"&&(!e.wearCount||e.wearCount===0)).length;let ae=0,O=0;n.forEach(e=>{ae+=parseFloat(e.cost)||0,O+=parseInt(e.wearCount)||0});const Se=O>0?ae/O:0,se=n.filter(e=>e.status!=="archived"&&(e.mainCategory&&e.mainCategory==="Nylons"||e.subCategory&&e.subCategory&&e.subCategory.toLowerCase().includes("strumpfhose"))),N=new Date,x=new Date;x.setDate(N.getDate()-30);const Ne=d.filter(e=>(e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date)>=x);let oe=0;const k=new Set;Ne.forEach(e=>{const o=e.itemIds||(e.itemId?[e.itemId]:[]);let f=!1;if(o.forEach(D=>{const w=n.find(_=>_.id===D);if(!w)return;const h=w.mainCategory||"",p=(w.subCategory||"").toLowerCase();(h==="Nylons"||p.includes("strumpfhose")||p.includes("stockings"))&&(f=!0,k.add(D))}),f){const D=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),w=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,h=D<x?x:D,p=w;p>h&&(oe+=(p-h)/6e4)}});const xe=k.size>0?oe/k.size/60:0,Re=se.reduce((e,o)=>e+(Number(o.totalMinutes)||0),0),Ee=se.reduce((e,o)=>e+(Number(o.cost)||0),0),re=Re/60,Le=re>0?Ee/re:0,ie=Qe(d);let z=0,ce=0;const R=new Date($);for(;R<=N;){z++;const e=new Date(R);e.setHours(2,0,0,0),e<=N&&Xe(e,d,n)&&ce++,R.setDate(R.getDate()+1)}const le=z>0?ce/z*100:0;let ue=0,K=0;const E=new Date($);for(;E<=N;){K++;const e=Ze(E,d,n);ue+=(1440-e)/60,E.setDate(E.getDate()+1)}const _e=K>0?ue/K:24;let W=0,de=0,me=0,A=0;M.forEach(e=>{const o=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),f=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,D=Math.max(0,f.getTime()-o.getTime());W+=D,e.type==="voluntary"&&(de+=D);const w=e.complianceLagMinutes,h=Number(w);!isNaN(h)&&h>=0&&(me+=h,A++)});const fe=W>0?de/W*100:0,De=M.length>0?M.filter(e=>e.type==="punishment").length/M.length*100:0,he=A>0?me/A:0,Ve=M.filter(e=>e.startTime);let L=0,G=0,F=0,U=0,Te=0,B=0;Ve.forEach(e=>{const o=e.startTime.toDate?e.startTime.toDate():new Date(e.startTime),f=e.endTime?e.endTime.toDate?e.endTime.toDate():new Date(e.endTime):new Date,D=Math.max(0,(f-o)/36e5),h=(e.itemIds||(e.itemId?[e.itemId]:[])).map(g=>n.find(v=>v.id===g)).filter(g=>g);if(h.length===0)return;const p=h.some(g=>{const v=(g.subCategory||"").toLowerCase();return(g.mainCategory||"").toLowerCase().includes("nylon")||v.includes("strumpfhose")||v.includes("stockings")}),_=h.some(g=>{const v=(g.subCategory||"").toLowerCase(),V=(g.mainCategory||"").toLowerCase();return V.includes("dessous")||V.includes("wÃ¤sche")||v.includes("body")||v.includes("slip")||v.includes("bh")||V.includes("corsage")});(p||_)&&(L+=D,G++),p&&(F+=D,U++),_&&(Te+=D,B++)});const ge=G>0?L/G:0,Pe=U>0?F/U:0,$e=B>0?Te/B:0,Y=L>0?F/L*100:0,He=C.totalReleases>0?C.cleanReleases/C.totalReleases*100:0,ye=Math.min(100,ge/12*100)*.4+Y*.6,je=Math.max(0,100-he*1.6),we=Math.max(0,fe*.6+je*.4-De*2),pe=le*.5+ie*.5,ve=Math.round(ye*.3+we*.3+pe*.4),Ie=new Date;Ie.setHours(0,0,0,0);const qe=d.filter(e=>e.startTime?(e.startTime.toDate?e.startTime.toDate():new Date(e.startTime))>=Ie:!1),J=new Set;qe.forEach(e=>{e.itemId&&J.add(e.itemId),e.itemIds&&e.itemIds.forEach(o=>J.add(o))}),a({health:{orphanCount:q},financials:{avgCPW:Me(Se)},usage:{nylonIndex:I(xe)},spermaScore:{rate:I(He),total:C.totalReleases,count:C.cleanReleases},coreMetrics:{nylonEnclosure:I(Y),nocturnal:I(le),nylonGap:H(_e),cpnh:Me(Le),complianceLag:be(he),coverage:I(ie),resistance:I(De),voluntarism:I(fe)+"%",endurance:H(ge),enduranceNylon:H(Pe),enduranceDessous:H($e),submission:"85.0",denial:"12.0",chastity:I(Y)},femIndex:{score:isNaN(ve)?0:Math.min(100,ve),trend:"stable",subScores:{physis:Math.round(ye),psyche:Math.round(we),infiltration:Math.round(pe)}},basics:{activeItems:b.length,washing:j.length,wornToday:J.size,archived:S.length}})}catch(d){console.error("Error fetching KPIs:",d)}finally{T(!1)}})()},[n,c,l,s,i]),{...m,loading:r,refreshKPIs:()=>y(u=>u+1)}}var te={},et=Q;Object.defineProperty(te,"__esModule",{value:!0});var tt=te.default=void 0,nt=et(X()),at=Z;tt=te.default=(0,nt.default)((0,at.jsx)("path",{d:"M12 1 3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11z"}),"Security");var ne={},st=Q;Object.defineProperty(ne,"__esModule",{value:!0});var ot=ne.default=void 0,rt=st(X()),it=Z;ot=ne.default=(0,rt.default)((0,it.jsx)("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"}),"TrendingUp");export{ot as a,Be as b,tt as d,ut as u};
