import{p as B,q as N,j as L,$ as _,t as d,v as l,y as A,z as w,J as R,w as y,x as V,ai as k,I as W,E as j}from"./index-C3CoDwPe.js";var C={},z=B;Object.defineProperty(C,"__esModule",{value:!0});var P=C.default=void 0,q=z(N()),I=L;P=C.default=(0,q.default)([(0,I.jsx)("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),(0,I.jsx)("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")],"WarningAmber");var x={},F=B;Object.defineProperty(x,"__esModule",{value:!0});var K=x.default=void 0,G=F(N()),Y=L;K=x.default=(0,G.default)((0,Y.jsx)("path",{d:"M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8M7.83 14c.37 0 .67.26.74.62.41 2.22 2.28 2.98 3.64 2.87.43-.02.79.32.79.75 0 .4-.32.73-.72.75-2.13.13-4.62-1.09-5.19-4.12-.08-.45.28-.87.74-.87"}),"WaterDrop");const H="items",U="settings/vibeTags",$=["Glatt","Samtig","Kratzig","Kühl","Warm","Eng anliegend","Locker","Sicher","Verboten","Verführerisch","Diskret","Kraftvoll","Verspielt","Büro","Draußen","Sportlich"],et=async e=>{try{const t=d(l,`users/${e}/${U}`),s=await y(t);if(s.exists()){const a=s.data();if(Array.isArray(a.list))return a.list}return await V(t,{list:$}),$}catch(t){return console.error("Fehler beim Laden der Vibe Tags:",t),$}},at=(e,t,s=24)=>{if(!e||e.mainCategory!=="Nylons")return null;let a=_(e.lastWorn);if(t&&Array.isArray(t)&&t.length>0){const i=t.find(f=>f.endTime);if(i){const f=_(i.endTime);f&&(!a||f>a)&&(a=f)}}if(!a)return null;const c=(new Date-a)/(1e3*60*60);return c<s?{isResting:!0,remainingHours:Math.ceil(s-c),progress:c/s*100}:null},J=async(e,t,s)=>{if(!e||!t)return;const a=d(l,`users/${e}/${H}`,t);await A(a,{wearCount:R(1),totalMinutes:R(s),lastWorn:w()})},Q={OVERDRAFT_PENALTY:1.5},X=async e=>{try{const t=d(l,`users/${e}/status/timeBank`),s=await y(t);if(s.exists())return s.data();{const a={nc:0,lc:0,updatedAt:w()};return await V(t,a),a}}catch(t){return console.error("Error loading TimeBank:",t),{nc:0,lc:0}}},st=async(e,t)=>{const s=await X(e),a=t==="nylon"?s.nc:s.lc,o=-2880;return{isBlocked:a<=o,currentDebt:Math.abs(a),remainingCredit:Math.max(0,a-o)}},nt=async(e,t,s)=>{if(t<=0)return!0;const a=s==="nylon"?"nc":"lc",o=d(l,`users/${e}/status/timeBank`),n=await y(o),c=n.exists()?n.data()[a]:0;let i=t;if((c<0||c-t<0)&&(i=Math.round(t*Q.OVERDRAFT_PENALTY),console.log(`TimeBank: Debt Penalty applied. Base: ${t}, Cost: ${i}`)),c-i<-2880)throw new Error("INSOLVENCY_LIMIT_REACHED");return await A(o,{[a]:R(-Math.abs(i)),lastTransaction:w()}),i},Z=async(e,t,s)=>{const a=s==="nylon"?"nc":"lc",o=d(l,`users/${e}/status/timeBank`),n=await y(o);if(!n.exists())return;const c=n.data()[a];let i=0;if(c<0)i=t;else{if(t<3)return;i=Math.floor(t/3)}if(!(i<=0))return await A(o,{[a]:R(i),lastTransaction:w()}),console.log(`TimeBank: Added ${i} ${s.toUpperCase()} credits.`),i},it=async(e,t)=>{const{items:s,itemId:a,type:o="voluntary",periodId:n,acceptedAt:c,note:i="",verifiedViaNfc:f=!1,instructionDurationMinutes:p=null}=t;if(!e)throw new Error("User ID fehlt.");let m=[];if(s&&Array.isArray(s)&&s.length>0?m=s:a&&(m=[{id:a}]),m.length===0)return;const D=m.map(r=>r.id);let M=0;if(o==="instruction"&&c){const r=new Date(c);if(!isNaN(r.getTime())){const u=Date.now()-r.getTime();M=Math.max(0,Math.floor(u/6e4))}}const g={userId:e,itemId:D[0],itemIds:D,type:o,startTime:w(),endTime:null,isActive:!0,note:i,targetDurationMinutes:p||null,complianceLagMinutes:M};o==="instruction"&&(g.periodId=n),f&&(g.verifiedViaNfc=!0);const T=await W(j(l,`users/${e}/sessions`),g),v=k(l);return D.forEach(r=>{v.update(d(l,`users/${e}/items`,r),{status:"wearing"})}),await v.commit(),{id:T.id,...g}},rt=async(e,t,s={})=>{var v;if(!e||!t)throw new Error("Parameter fehlen.");const a=d(l,`users/${e}/sessions`,t),o=await y(a);if(!o.exists()){console.error("Session nicht gefunden:",t);return}const n=o.data(),c=k(l),i=new Date,f=(v=n.startTime)!=null&&v.toDate?n.startTime.toDate():new Date,p=Math.round((i-f)/6e4);let m=null;const D=n.type==="instruction",M=n.periodId&&n.periodId.toLowerCase().includes("night");if(D&&!M){m=!1;const r=i.getTimezoneOffset()*6e4,u=new Date(i.getTime()-r).toISOString().split("T")[0];try{const h=d(l,`users/${e}/status/nightCompliance`),E=await y(h);if(E.exists()){const S=E.data();S.date===u&&(m=S.success)}}catch(h){console.error(h)}}const g={endTime:w(),isActive:!1,durationMinutes:p,feelings:s.feelings||[],finalNote:s.note||""};m!==null&&(g.nightSuccess=m),c.update(a,g);const T=n.itemIds||(n.itemId?[n.itemId]:[]);T.forEach(r=>{const u=d(l,`users/${e}/items`,r);c.update(u,{status:"active",lastWorn:w()})}),await c.commit();for(const r of T)await J(e,r,p);if(n.type!=="punishment"&&!n.tzdExecuted){let r=0;if(n.type==="voluntary")r=p;else if(n.type==="instruction"){const u=n.targetDurationMinutes||0;p>u&&u>0&&(r=p-u)}if(r>0){let u="lingerie";try{const h=T[0],E=await y(d(l,`users/${e}/items`,h));if(E.exists()){const S=E.data(),b=(S.subCategory||"").toLowerCase(),O=(S.mainCategory||"").toLowerCase();(b.includes("strumpfhose")||b.includes("tights")||b.includes("halterlose")||b.includes("stockings")||O.includes("nylons"))&&(u="nylon")}await Z(e,r,u)}catch(h){console.error("Error calculating credits",h)}}}return{...n,endTime:i,durationMinutes:p}};export{P as a,it as b,st as c,K as d,rt as e,at as f,X as g,et as l,nt as s};
