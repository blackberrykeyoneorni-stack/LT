import{m as _,n as A,j as L,o as w,p,q as T,w as v,t as P,v as O,G as R,ak as k,F as z,y as V}from"./index-D8WB5g1X.js";var B={},q=_;Object.defineProperty(B,"__esModule",{value:!0});var W=B.default=void 0,F=q(A()),I=L;W=B.default=(0,F.default)([(0,I.jsx)("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),(0,I.jsx)("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")],"WarningAmber");var N={},K=_;Object.defineProperty(N,"__esModule",{value:!0});var Y=N.default=void 0,G=K(A()),H=L;Y=N.default=(0,G.default)((0,H.jsx)("path",{d:"M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8M7.83 14c.37 0 .67.26.74.62.41 2.22 2.28 2.98 3.64 2.87.43-.02.79.32.79.75 0 .4-.32.73-.72.75-2.13.13-4.62-1.09-5.19-4.12-.08-.45.28-.87.74-.87"}),"WaterDrop");const U={OVERDRAFT_PENALTY:1.5},j=async s=>{try{const e=w(p,`users/${s}/status/timeBank`),i=await T(e);if(i.exists())return i.data();{const o={nc:0,lc:0,updatedAt:v()};return await P(e,o),o}}catch(e){return console.error("Error loading TimeBank:",e),{nc:0,lc:0}}},X=async(s,e)=>{const i=await j(s),o=e==="nylon"?i.nc:i.lc,r=-2880;return{isBlocked:o<=r,currentDebt:Math.abs(o),remainingCredit:Math.max(0,o-r)}},Z=async(s,e,i)=>{if(e<=0)return!0;const o=i==="nylon"?"nc":"lc",r=w(p,`users/${s}/status/timeBank`),t=await T(r),l=t.exists()?t.data()[o]:0;let n=e;if((l<0||l-e<0)&&(n=Math.round(e*U.OVERDRAFT_PENALTY),console.log(`TimeBank: Debt Penalty applied. Base: ${e}, Cost: ${n}`)),l-n<-2880)throw new Error("INSOLVENCY_LIMIT_REACHED");return await O(r,{[o]:R(-Math.abs(n)),lastTransaction:v()}),n},J=async(s,e,i)=>{const o=i==="nylon"?"nc":"lc",r=w(p,`users/${s}/status/timeBank`),t=await T(r);if(!t.exists())return;const l=t.data()[o];let n=0;if(l<0)n=e;else{if(e<3)return;n=Math.floor(e/3)}if(!(n<=0))return await O(r,{[o]:R(n),lastTransaction:v()}),console.log(`TimeBank: Added ${n} ${i.toUpperCase()} credits.`),n},ee=async(s,e)=>{const{items:i,itemId:o,type:r="voluntary",periodId:t,acceptedAt:l,note:n="",verifiedViaNfc:x=!1,instructionDurationMinutes:f=null}=e;if(!s)throw new Error("User ID fehlt.");let m=[];if(i&&Array.isArray(i)&&i.length>0?m=i:o&&(m=[{id:o}]),m.length===0)return;const b=m.map(a=>a.id),E=m[0],y=await j(s);let h=null,D=0;y.nc<0?(h="nylon",D=Math.abs(y.nc)):y.lc<0&&(h="lingerie",D=Math.abs(y.lc));let C=!1,S=0;if(h){const a=(E.subCategory||"").toLowerCase(),M=(E.mainCategory||"").toLowerCase(),$=a.includes("strumpfhose")||a.includes("tights")||a.includes("halterlose")||a.includes("stockings")||M.includes("nylons");if(h==="nylon"&&!$)throw new Error("BLOCKIERT: Nylon-Schulden mÃ¼ssen mit Nylons getilgt werden.");if(h==="lingerie"&&$)throw new Error("BLOCKIERT: Dessous-Schulden erfordern Lingerie.");C=!0,S=D,console.log(`DEBT PROTOCOL: Session enforced for ${D} mins (${h}).`)}let u=0;if(r==="instruction"&&l){const a=new Date(l);if(!isNaN(a.getTime())){const M=Date.now()-a.getTime();u=Math.max(0,Math.floor(M/6e4))}}const c={userId:s,itemId:b[0],itemIds:b,type:r,startTime:v(),endTime:null,isActive:!0,note:n,targetDurationMinutes:f?Number(f):null,complianceLagMinutes:u,isDebtSession:C,minDuration:S};r==="instruction"&&(c.periodId=t),x&&(c.verifiedViaNfc=!0);const d=await z(V(p,`users/${s}/sessions`),c),g=k(p);return b.forEach(a=>{g.update(w(p,`users/${s}/items`,a),{status:"wearing"})}),await g.commit(),{id:d.id,...c}},te=async(s,e,i={})=>{var S;if(!s||!e)throw new Error("Parameter fehlen.");const o=w(p,`users/${s}/sessions`,e),r=await T(o);if(!r.exists()){console.error("Session nicht gefunden:",e);return}const t=r.data(),l=k(p),n=new Date,x=(S=t.startTime)!=null&&S.toDate?t.startTime.toDate():new Date,f=Math.round((n-x)/6e4);let m=null;const b=t.type==="instruction",E=t.periodId&&t.periodId.toLowerCase().includes("night");if(b&&!E){m=!1;const u=n.getTimezoneOffset()*6e4,c=new Date(n.getTime()-u).toISOString().split("T")[0];try{const d=w(p,`users/${s}/status/nightCompliance`),g=await T(d);if(g.exists()){const a=g.data();a.date===c&&(m=a.success)}}catch(d){console.error(d)}}const y={endTime:v(),isActive:!1,durationMinutes:f,feelings:i.feelings||[],finalNote:i.note||""};m!==null&&(y.nightSuccess=m),l.update(o,y);const h=t.itemIds||(t.itemId?[t.itemId]:[]),D=[];for(const u of h){const c=w(p,`users/${s}/items`,u);l.update(c,{status:"active",lastWorn:v(),wearCount:R(1),totalMinutes:R(f)});try{const d=await T(c);d.exists()&&D.push(d.data())}catch(d){console.error(d)}}let C=!1;if(t.type!=="punishment"&&!t.tzdExecuted){let u=0;if(t.isDebtSession)u=f;else if(t.type==="voluntary")u=f;else if(t.type==="instruction"){const c=Number(t.targetDurationMinutes)||0;c>0&&f>c&&(u=f-c)}if(u>0){const d=D.some(g=>{const a=(g.subCategory||"").toLowerCase(),M=(g.mainCategory||"").toLowerCase();return a.includes("strumpfhose")||a.includes("tights")||a.includes("halterlose")||a.includes("stockings")||M.includes("nylons")})?"nylon":"lingerie";await J(s,u,d),C=!0}}return await l.commit(),{id:e,...t,endTime:n,durationMinutes:f,creditCalculated:C}};export{W as a,ee as b,X as c,Y as d,te as e,j as g,Z as s};
